{% extends 'base.html' %}
{% load static %}

{% block title %} Gesti贸n de Usuarios | Huella Urbana{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/usuario.css' %}">

{% endblock %}

{% block content %}

<!-- HERO HEADER -->
<div class="hero-header fade-in-up" style="animation-delay: 0s;">
    <h1>
        <i class="fas fa-users-cog"></i>
        Gesti贸n de Usuarios
    </h1>
    <p class="hero-subtitle">Administra roles, permisos y actividad de tu comunidad con estilo</p>
</div>

<!-- SEARCH BAR + FILTROS EN LA MISMA LNEA -->
<div class="search-filters-container fade-in-up" style="animation-delay: 0.1s;">
    <!-- Buscador -->
    <div class="search-wrapper">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Buscar usuarios...">
        </div>
    </div>

    <!-- Filtros de Roles -->
    <div class="filters-grid">
        <div class="filter-card filter-btn active" data-filter="all">
            <div class="filter-info">
                <i class="fas fa-users"></i>
                <span class="filter-title">Todos</span>
                <span class="filter-count">{{ usuarios.count }}</span>
            </div>
        </div>
        
        <div class="filter-card filter-btn" data-filter="admin">
            <div class="filter-info">
                <i class="fas fa-crown"></i>
                <span class="filter-title">Admins</span>
                <span class="filter-count">{{ admins_count }}</span>
            </div>
        </div>
        
        <div class="filter-card filter-btn" data-filter="moderador">
            <div class="filter-info">
                <i class="fas fa-shield-alt"></i>
                <span class="filter-title">Moderadores</span>
                <span class="filter-count">{{ moderadores_count }}</span>
            </div>
        </div>
        
        <div class="filter-card filter-btn" data-filter="usuario">
            <div class="filter-info">
                <i class="fas fa-user"></i>
                <span class="filter-title">Usuarios</span>
                <span class="filter-count">{{ usuarios_count }}</span>
            </div>
        </div>
    </div>
</div>

<!-- GRID DE USUARIOS -->
<div class="users-grid">
    {% for usuario in usuarios %}
    <div class="user-item fade-in-up"
         data-role="{{ usuario.perfil.rol }}"
         data-name="{{ usuario.get_full_name|lower }}"
         data-email="{{ usuario.email|lower }}"
         style="animation-delay: {{ forloop.counter0|floatformat:1|add:'0.3' }}s;">
        
        <div class="user-card-modern">
            <!-- Banner superior con gradiente seg煤n rol -->
            <div class="card-banner {{ usuario.perfil.rol }}"></div>
            
            <!-- Avatar flotante -->
            <div class="avatar-container">
                <div class="avatar-circle {{ usuario.perfil.rol }}">
                    <i class="fas
                    {% if usuario.perfil.rol == 'admin' %}fa-crown
                    {% elif usuario.perfil.rol == 'moderador' %}fa-shield-alt
                    {% else %}fa-user{% endif %}">
                    </i>
                </div>
            </div>
            
            <!-- Contenido del card -->
            <div class="card-content">
                <div class="user-name-modern">
                    {{ usuario.get_full_name|default:usuario.username }}
                </div>
                
                <div class="role-badge-modern {{ usuario.perfil.rol }}">
                    <i class="fas
                    {% if usuario.perfil.rol == 'admin' %}fa-crown
                    {% elif usuario.perfil.rol == 'moderador' %}fa-shield-alt
                    {% else %}fa-user{% endif %}">
                    </i>
                    {% if usuario.perfil.rol == 'admin' %}Administrador
                    {% elif usuario.perfil.rol == 'moderador' %}Moderador
                    {% else %}Usuario{% endif %}
                </div>
                
                <!-- Informaci贸n del usuario -->
                <div class="info-items">
                    <div class="info-item">
                        <i class="fas fa-envelope"></i>
                        <span>{{ usuario.email }}</span>
                    </div>
                    
                    <div class="info-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Desde {{ usuario.date_joined|date:"M Y" }}</span>
                    </div>
                    
                    <div class="info-item">
                        <i class="fas {% if usuario.perfil.rol != 'usuario' %}fa-check-circle{% else %}fa-file-alt{% endif %}"></i>
                        <span>
                            {% if usuario.perfil.rol != 'usuario' %}
                                {{ usuario.reportes_moderados.count }} moderados
                            {% else %}
                                {{ usuario.reportes.count }} reportes
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                <!-- Botones de acci贸n -->
                <div class="action-buttons">
                    <button class="btn-modern btn-edit-modern" onclick="editUser({{ usuario.id }})">
                        <i class="fas fa-edit"></i>
                        Editar
                    </button>
                    
                    {% if user.perfil.rol == 'admin' and usuario.perfil.rol != 'admin' %}
                    <button class="btn-modern btn-delete-modern" onclick="deleteUser({{ usuario.id }}, '{{ usuario.username }}')">
                        <i class="fas fa-trash-alt"></i>
                        Eliminar
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div style="grid-column: 1/-1; text-align: center; color: white; font-size: 1.5rem; padding: 3rem;">
        <i class="fas fa-users-slash" style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;"></i>
        <p>No hay usuarios registrados</p>
    </div>
    {% endfor %}
</div>

<!-- BOTN FLOTANTE PARA CREAR USUARIOS -->
<button class="fab-button" onclick="addUser()" title="Crear Usuario">
    <i class="fas fa-plus"></i>
</button>

{% endblock %}

{% block extra_scripts %}
<script>
/* ===========================
   BUSCADOR
=========================== */
document.getElementById('searchInput').addEventListener('input', function(e) {
    const search = e.target.value.toLowerCase();
    document.querySelectorAll('.user-item').forEach(item => {
        const name = item.dataset.name;
        const email = item.dataset.email;
        item.style.display = (name.includes(search) || email.includes(search)) ? 'block' : 'none';
    });
});

/* ===========================
   FILTROS POR ROL
=========================== */
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        const filter = this.dataset.filter;

        document.querySelectorAll('.user-item').forEach(item => {
            item.style.display =
                (filter === 'all' || item.dataset.role === filter)
                ? 'block' : 'none';
        });
    });
});


/* ===========================
   CREAR USUARIO (+)
=========================== */
function addUser() {
    Swal.fire({
        title: "Crear Usuario",
        html: `
            <input id="swal-name" class="swal2-input" placeholder="Nombre completo">
            <input id="swal-username" class="swal2-input" placeholder="Nombre de usuario">
            <input id="swal-email" class="swal2-input" placeholder="Email">
            <input id="swal-password" class="swal2-input" type="password" placeholder="Contrase帽a">

            <select id="swal-role" class="swal2-select">
                <option value="">Selecciona un rol</option>
                <option value="usuario">Usuario</option>
                <option value="moderador">Moderador</option>
                <option value="admin">Administrador</option>
            </select>
        `,
        confirmButtonText: 'Crear',
        showCancelButton: true,
        preConfirm: () => {
            const name = document.getElementById("swal-name").value;
            const username = document.getElementById("swal-username").value;
            const email = document.getElementById("swal-email").value;
            const password = document.getElementById("swal-password").value;
            const role = document.getElementById("swal-role").value;

            if (!name || !username || !email || !password || !role) {
                Swal.showValidationMessage("Todos los campos son obligatorios");
                return false;
            }
            return { name, username, email, password, role };
        }
    }).then(result => {
        if (result.isConfirmed) {
            fetch("{% url 'crear_usuario' %}", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify(result.value)
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    Swal.fire("xito", data.message, "success")
                        .then(() => location.reload());
                } else {
                    Swal.fire("Error", data.message, "error");
                }
            });
        }
    });
}


/* ===========================
   EDITAR USUARIO
=========================== */
function editUser(id) {
    fetch(`/usuarios/${id}/editar/`)
        .then(r => r.json())
        .then(data => {

            Swal.fire({
                title: "Editar Usuario",
                html: `
                    <input id="edit-name" class="swal2-input" value="${data.name}">
                    <input id="edit-email" class="swal2-input" value="${data.email}">
                    <select id="edit-role" class="swal2-select">
                        <option value="usuario" ${data.role === "usuario" ? "selected" : ""}>Usuario</option>
                        <option value="moderador" ${data.role === "moderador" ? "selected" : ""}>Moderador</option>
                        <option value="admin" ${data.role === "admin" ? "selected" : ""}>Administrador</option>
                    </select>
                `,
                showCancelButton: true,
                confirmButtonText: "Guardar"
            }).then(result => {
                if (result.isConfirmed) {

                    const payload = {
                        name: document.getElementById('edit-name').value,
                        email: document.getElementById('edit-email').value,
                        role: document.getElementById('edit-role').value
                    };

                    fetch(`/usuarios/${id}/editar/`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(r => r.json())
                    .then(data => {
                        Swal.fire("Actualizado", data.message, "success")
                            .then(() => location.reload());
                    });
                }
            });
        });
}


/* ===========================
   ELIMINAR
=========================== */
function deleteUser(id, username) {
    Swal.fire({
        title: "Eliminar Usuario",
        text: `Se eliminar谩 a ${username}`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Eliminar",
        confirmButtonColor: "#DC2626"
    }).then(result => {
        if (result.isConfirmed) {
            fetch(`/usuarios/${id}/eliminar/`, {
                method: "DELETE",
                headers: { "X-CSRFToken": "{{ csrf_token }}" }
            })
            .then(r => r.json())
            .then(data => {
                Swal.fire("Eliminado", data.message, "success")
                    .then(() => location.reload());
            });
        }
    });
}
</script>
{% endblock %}