{% extends 'base.html' %}
{% load static %}

{% block title %}游늵 Estad칤sticas | Huella Urbana{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/estadistica.css' %}">
{% endblock %}

{% block content %}

    <div class="stats-hero">
        <div class="container">
            <h1 class="text-center mb-4" style="font-weight: 900; font-size: 3rem;">
                游늵 Panel de Estad칤sticas
            </h1>
            <p class="text-center mb-5" style="font-size: 1.2rem; opacity: 0.95;">
                An치lisis detallado de incidentes en Valdivia
            </p>

            <div class="row g-4">
                <div class="col-md-3 col-6">
                    <div class="stat-card-big fade-in-up">
                        <div class="stat-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="stat-number">{{ total_reportes }}</div>
                        <div class="stat-label">Reportes Totales</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card-big fade-in-up" style="animation-delay: 0.1s;">
                        <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-number">{{ verificados }}</div>
                        <div class="stat-label">Verificados</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card-big fade-in-up" style="animation-delay: 0.2s;">
                        <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="stat-number">{{ ataques_graves }}</div>
                        <div class="stat-label">Ataques Graves</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card-big fade-in-up" style="animation-delay: 0.3s;">
                        <div class="stat-icon"><i class="fas fa-map-marked-alt"></i></div>
                        <div class="stat-number">{{ sectores_afectados }}</div>
                        <div class="stat-label">Sectores Afectados</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mb-5">

        <div class="custom-tabs">
            <button class="tab-btn active" onclick="showTab('general')">
                <i class="fas fa-chart-line"></i> General
            </button>
            <button class="tab-btn" onclick="showTab('temporal')">
                <i class="fas fa-calendar"></i> Temporal
            </button>
            <button class="tab-btn" onclick="showTab('geografico')">
                <i class="fas fa-map"></i> Geogr치fico
            </button>
            <button class="tab-btn" onclick="showTab('insights')">
                <i class="fas fa-lightbulb"></i> Insights
            </button>
        </div>

        <div id="tab-general" class="tab-content active">
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="chart-card fade-in-up">
                        <div class="chart-header">
                            <div class="chart-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div class="chart-title">
                                <h3>Reportes por Mes</h3>
                                <small>Evoluci칩n mensual de incidentes</small>
                            </div>
                        </div>
                        <canvas id="chartBarras" height="300"></canvas>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="chart-card fade-in-up" style="animation-delay: 0.1s;">
                        <div class="chart-header">
                            <div class="chart-icon" style="background: linear-gradient(135deg, var(--color-danger), #DC2626);">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div class="chart-title">
                                <h3>Distribuci칩n por Gravedad</h3>
                                <small>Clasificaci칩n de ataques</small>
                            </div>
                        </div>
                        <canvas id="chartDona" height="300"></canvas>
                    </div>
                </div>

                <div class="col-12">
                    <div class="chart-card fade-in-up" style="animation-delay: 0.2s;">
                        <div class="chart-header">
                            <div class="chart-icon" style="background: linear-gradient(135deg, var(--color-success), #059669);">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="chart-title">
                                <h3>Top 10 Sectores M치s Afectados</h3>
                                <small>Zonas con mayor cantidad de incidentes</small>
                            </div>
                        </div>

                        <div class="ranking-table">
                            {% for sector in sectores_ranking %}
                            <div class="ranking-row">
                                <div class="ranking-position" 
                                     {% if forloop.counter == 2 %}style="background: linear-gradient(135deg, var(--color-secondary), #3B82F6);"
                                     {% elif forloop.counter == 3 %}style="background: linear-gradient(135deg, var(--color-success), #059669);"
                                     {% elif forloop.counter == 4 %}style="background: linear-gradient(135deg, var(--color-warning), #F59E0B);"
                                     {% elif forloop.counter >= 5 %}style="background: #6B7280;"{% endif %}>
                                    {{ forloop.counter }}
                                </div>
                                <div class="ranking-info">
                                    <strong>{{ sector.sector }}</strong><br>
                                    <small class="text-muted">Sector</small>
                                </div>
                                <div class="ranking-value">{{ sector.total }}</div>
                            </div>
                            {% empty %}
                            <p class="text-muted text-center">No hay datos disponibles</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-temporal" class="tab-content">
            <div class="row g-4">
                <div class="col-12">
                    <div class="chart-card fade-in-up">
                        <div class="chart-header">
                            <div class="chart-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="chart-title">
                                <h3>Tendencia Temporal</h3>
                                <small>Evoluci칩n de incidentes en el tiempo</small>
                            </div>
                        </div>
                        <canvas id="chartLinea" height="100"></canvas>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="chart-card fade-in-up">
                        <div class="chart-header">
                            <div class="chart-icon" style="background: linear-gradient(135deg, var(--color-warning), #F59E0B);">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="chart-title">
                                <h3>Incidentes por Hora del D칤a</h3>
                                <small>Horarios m치s frecuentes</small>
                            </div>
                        </div>
                        <canvas id="chartHoras" height="250"></canvas>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="chart-card fade-in-up">
                        <div class="chart-header">
                            <div class="chart-icon" style="background: linear-gradient(135deg, var(--color-secondary), #3B82F6);">
                                <i class="fas fa-calendar-week"></i>
                            </div>
                            <div class="chart-title">
                                <h3>Incidentes por D칤a de la Semana</h3>
                                <small>Distribuci칩n semanal</small>
                            </div>
                        </div>
                        <canvas id="chartDias" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-geografico" class="tab-content">
            <div class="row g-4">
                <div class="col-12">
                    <div class="chart-card fade-in-up">
                        <div class="chart-header">
                            <div class="chart-icon" style="background: linear-gradient(135deg, var(--color-success), #059669);">
                                <i class="fas fa-map"></i>
                            </div>
                            <div class="chart-title">
                                <h3>Distribuci칩n Geogr치fica</h3>
                                <small>Incidentes por sector</small>
                            </div>
                        </div>

                        {% for sector in sectores_ranking %}
                        {% widthratio sector.total max_sector 100 as width_percent %}
                        <div class="progress-item">
                            <div class="progress-label">
                                <span><i class="fas fa-map-marker-alt"></i> {{ sector.sector }}</span>
                                <span>{{ sector.total }} incidentes</span>
                            </div>
                            <div class="progress-custom">
                                <div class="progress-bar-custom" style="width: {{ width_percent }}%; 
                                    {% if forloop.counter == 1 %}background: linear-gradient(135deg, var(--color-danger), #DC2626);
                                    {% elif forloop.counter == 2 %}background: linear-gradient(135deg, var(--color-warning), #F59E0B);
                                    {% elif forloop.counter == 3 %}background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
                                    {% elif forloop.counter == 4 %}background: linear-gradient(135deg, var(--color-success), #059669);
                                    {% else %}background: linear-gradient(135deg, var(--color-secondary), #3B82F6);{% endif %}">
                                    {{ width_percent }}%
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-insights" class="tab-content">
            <div class="row g-4">
                <div class="col-12">
                    <div class="chart-card fade-in-up">
                        <div class="chart-header">
                            <div class="chart-icon">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <div class="chart-title">
                                <h3>M칠tricas de Calidad</h3>
                                <small>Indicadores de desempe침o del sistema</small>
                            </div>
                        </div>

                        <div class="row g-4 mt-2">
                            <div class="col-md-3 text-center">
                                <div style="font-size: 3rem; color: var(--color-success);">
                                    <i class="fas fa-percentage"></i>
                                </div>
                                <h2 style="color: var(--color-success); font-weight: 800;">{{ tasa_aprobacion }}%</h2>
                                <p class="text-muted">Tasa de Aprobaci칩n</p>
                            </div>
                            <div class="col-md-3 text-center">
                                <div style="font-size: 3rem; color: var(--color-primary);">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <h2 style="color: var(--color-primary); font-weight: 800;">24h</h2>
                                <p class="text-muted">Tiempo de Respuesta</p>
                            </div>
                            <div class="col-md-3 text-center">
                                <div style="font-size: 3rem; color: var(--color-secondary);">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <h2 style="color: var(--color-secondary); font-weight: 800;">{{ porcentaje_con_foto }}%</h2>
                                <p class="text-muted">Con Fotograf칤as</p>
                            </div>
                            <div class="col-md-3 text-center">
                                <div style="font-size: 3rem; color: var(--color-warning);">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <h2 style="color: var(--color-warning); font-weight: 800;">{{ verificados }}</h2>
                                <p class="text-muted">Reportes Verificados</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Funci칩n para cambiar tabs
function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

    const activeTab = document.getElementById('tab-' + tabName);
    if (activeTab) activeTab.classList.add('active');

    const clickedBtn = [...document.querySelectorAll('.tab-btn')]
        .find(btn => btn.innerText.toLowerCase().includes(tabName));
    if (clickedBtn) clickedBtn.classList.add('active');
}

// Inicializar gr치ficos cuando el DOM est칠 listo
document.addEventListener('DOMContentLoaded', function() {
    // Gr치fico de Barras - Reportes por Mes
    const ctxBarras = document.getElementById('chartBarras').getContext('2d');
    new Chart(ctxBarras, {
        type: 'bar',
        data: {
            labels: {{ meses|safe }},
            datasets: [{
                label: 'Reportes',
                data: {{ totales_mes|safe }},
                backgroundColor: 'rgba(139, 92, 246, 0.8)',
                borderColor: 'rgba(139, 92, 246, 1)',
                borderWidth: 2,
                borderRadius: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Gr치fico de Dona - Distribuci칩n por Gravedad
    const ctxDona = document.getElementById('chartDona').getContext('2d');
    new Chart(ctxDona, {
        type: 'doughnut',
        data: {
            labels: ['Graves', 'Moderados', 'Leves'],
            datasets: [{
                data: [{{ graves }}, {{ moderados }}, {{ leves }}],
                backgroundColor: [
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(96, 165, 250, 0.8)'
                ],
                borderWidth: 3,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { padding: 20, font: { size: 14 } } }
            }
        }
    });

    // Gr치fico de L칤nea - Tendencia Temporal
    const ctxLinea = document.getElementById('chartLinea').getContext('2d');
    new Chart(ctxLinea, {
        type: 'line',
        data: {
            labels: {{ meses_tendencia|safe }},
            datasets: [{
                label: 'Incidentes',
                data: {{ totales_tendencia|safe }},
                borderColor: 'rgba(139, 92, 246, 1)',
                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true, position: 'top' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Gr치fico de Barras - Incidentes por Hora
    const ctxHoras = document.getElementById('chartHoras').getContext('2d');
    new Chart(ctxHoras, {
        type: 'bar',
        data: {
            labels: {{ etiquetas_horas|safe }},
            datasets: [{
                label: 'Incidentes',
                data: {{ totales_horas|safe }},
                backgroundColor: 'rgba(245, 158, 11, 0.8)',
                borderColor: 'rgba(245, 158, 11, 1)',
                borderWidth: 2,
                borderRadius: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Gr치fico de Barras - Incidentes por D칤a
    const ctxDias = document.getElementById('chartDias').getContext('2d');
    new Chart(ctxDias, {
        type: 'bar',
        data: {
            labels: {{ dias_ordenados|safe }},
            datasets: [{
                label: 'Incidentes',
                data: {{ totales_dias|safe }},
                backgroundColor: 'rgba(96, 165, 250, 0.8)',
                borderColor: 'rgba(96, 165, 250, 1)',
                borderWidth: 2,
                borderRadius: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
});
</script>
{% endblock %}