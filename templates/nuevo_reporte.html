{% extends 'base.html' %}
{% load static %}

{% block title %}üêæ Nuevo Reporte | Huella Urbana{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/nuevo_reporte.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
{% endblock %}

{% block content %}
<br>
<div class="form-container">
  <!-- HEADER -->
  <div class="form-header">
    <h1><i class="fas fa-paw"></i> Nuevo Reporte</h1>
    <p>Ay√∫danos a documentar incidentes de perros callejeros en Valdivia</p>
  </div>

  <!-- STEPS -->
  <div class="steps-indicator">
    <div class="step active" data-step="1">
      <div class="step-circle">1</div>
      <div class="step-label">Informaci√≥n</div>
    </div>
    <div class="step" data-step="2">
      <div class="step-circle">2</div>
      <div class="step-label">Ubicaci√≥n</div>
    </div>
    <div class="step" data-step="3">
      <div class="step-circle">3</div>
      <div class="step-label">Evidencia</div>
    </div>
  </div>

  <!-- FORM -->
  <form method="POST" enctype="multipart/form-data" id="reportForm">
    {% csrf_token %}

    <!-- PASO 1: INFORMACI√ìN -->
    <div class="step-content active" data-step="1">
      <div class="info-box">
        <h5><i class="fas fa-info-circle"></i> Paso 1: Informaci√≥n B√°sica</h5>
        <p class="mb-0">Completa los datos del incidente. Los campos con <span class="required">*</span> son obligatorios.</p>
      </div>

      <div class="form-group">
        <label class="form-label"><i class="fas fa-heading"></i> T√≠tulo del Incidente <span class="required">*</span></label>
        {{ form.titulo }}
        {% if form.titulo.errors %}<div class="text-danger"><i class="fas fa-exclamation-circle"></i> {{ form.titulo.errors }}</div>{% endif %}
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label"><i class="fas fa-calendar"></i> Fecha del Incidente <span class="required">*</span></label>
          {{ form.fecha }}
          <div class="date-warning" id="dateWarning">
            <i class="fas fa-exclamation-triangle"></i> No puedes seleccionar una fecha futura
          </div>
          {% if form.fecha.errors %}<div class="text-danger"><i class="fas fa-exclamation-circle"></i> {{ form.fecha.errors }}</div>{% endif %}
        </div>
        <div class="form-group">
          <label class="form-label"><i class="fas fa-clock"></i> Hora Aproximada</label>
          {{ form.hora }}
          {% if form.hora.errors %}<div class="text-danger"><i class="fas fa-exclamation-circle"></i> {{ form.hora.errors }}</div>{% endif %}
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label"><i class="fas fa-paw"></i> Tipo de Animal V√≠ctima <span class="required">*</span></label>
          {{ form.tipo_animal }}
          {% if form.tipo_animal.errors %}<div class="text-danger"><i class="fas fa-exclamation-circle"></i> {{ form.tipo_animal.errors }}</div>{% endif %}
        </div>
        <div class="form-group">
          <label class="form-label"><i class="fas fa-dog"></i> Cantidad de Perros Agresores</label>
          {{ form.cantidad_perros }}
          {% if form.cantidad_perros.errors %}<div class="text-danger"><i class="fas fa-exclamation-circle"></i> {{ form.cantidad_perros.errors }}</div>{% endif %}
        </div>
      </div>

      <!-- GRAVEDAD -->
      <div class="form-group">
        <label class="form-label"><i class="fas fa-exclamation-triangle"></i> Gravedad del Ataque <span class="required">*</span></label>
        
        {{ form.gravedad }}
        
        <div class="severity-options">
          <div class="severity-option severity-leve" data-value="leve">
            <div class="severity-content">
              <div class="severity-icon" style="color: var(--color-secondary);"><i class="fas fa-info-circle"></i></div>
              <h5>Leve</h5>
              <p class="text-muted">Sin heridas graves</p>
            </div>
          </div>
          <div class="severity-option severity-moderado" data-value="moderado">
            <div class="severity-content">
              <div class="severity-icon" style="color: var(--color-warning);"><i class="fas fa-exclamation-circle"></i></div>
              <h5>Moderado</h5>
              <p class="text-muted">Heridas menores</p>
            </div>
          </div>
          <div class="severity-option severity-grave" data-value="grave">
            <div class="severity-content">
              <div class="severity-icon" style="color: var(--color-danger);"><i class="fas fa-skull-crossbones"></i></div>
              <h5>Grave</h5>
              <p class="text-muted">Heridas serias o fatales</p>
            </div>
          </div>
        </div>

        {% if form.gravedad.errors %}<div class="text-danger"><i class="fas fa-exclamation-circle"></i> {{ form.gravedad.errors }}</div>{% endif %}

        <div id="gravedadIndicator" style="display:none; margin-top:10px; color:#10B981; font-size:0.9rem;">
          <i class="fas fa-check-circle"></i> Gravedad seleccionada: <strong id="gravedadSelected"></strong>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label"><i class="fas fa-align-left"></i> Descripci√≥n Detallada del Incidente <span class="required">*</span></label>
        {{ form.descripcion }}
        <div class="progress-bar">
          <div class="progress-fill" id="descProgress" style="width: 0%"></div>
        </div>
        <span class="char-counter invalid" id="charCount">M√≠nimo 50 caracteres (0/50)</span>
        {% if form.descripcion.errors %}<div class="text-danger"><i class="fas fa-exclamation-circle"></i> {{ form.descripcion.errors }}</div>{% endif %}
      </div>
    </div>

    <!-- PASO 2: UBICACI√ìN -->
    <div class="step-content" data-step="2">
      <div class="info-box">
        <h5><i class="fas fa-map-marker-alt"></i> Paso 2: Ubicaci√≥n del Incidente</h5>
        <p class="mb-0">Indica d√≥nde ocurri√≥ el ataque. Puedes escribir la direcci√≥n o hacer clic en el mapa.</p>
      </div>

      <div class="form-group">
        <label class="form-label"><i class="fas fa-map-marker-alt"></i> Direcci√≥n / Calle <span class="required">*</span></label>
        {{ form.direccion }}
        {% if form.direccion.errors %}<div class="text-danger"><i class="fas fa-exclamation-circle"></i> {{ form.direccion.errors }}</div>{% endif %}
      </div>

      <div class="form-group">
        <label class="form-label"><i class="fas fa-city"></i> Sector</label>
        {{ form.sector }}
        {% if form.sector.errors %}<div class="text-danger"><i class="fas fa-exclamation-circle"></i> {{ form.sector.errors }}</div>{% endif %}
      </div>

      <div class="form-group">
        <label class="form-label"><i class="fas fa-map"></i> Haz clic en el mapa para marcar la ubicaci√≥n exacta</label>
        <div id="map"></div>
        {{ form.latitud }}
        {{ form.longitud }}
        <div class="location-info" id="locationInfo" style="display:none;">
          <i class="fas fa-check-circle"></i>
          <div>
            <strong>Ubicaci√≥n seleccionada</strong><br>
            <small>Latitud: <span id="lat">-39.8142</span> | Longitud: <span id="lng">-73.2459</span></small>
          </div>
        </div>
      </div>
    </div>

    <!-- PASO 3: EVIDENCIA -->
    <div class="step-content" data-step="3">
      <div class="info-box">
        <h5><i class="fas fa-camera"></i> Paso 3: Evidencia Fotogr√°fica</h5>
        <p class="mb-0">Sube fotograf√≠as del incidente. Las im√°genes ayudan a validar tu reporte m√°s r√°pido.</p>
      </div>

      <div class="form-group">
        <label class="form-label"><i class="fas fa-camera"></i> Fotograf√≠as del Incidente</label>
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
          <div class="upload-text">Arrastra im√°genes aqu√≠ o haz clic para seleccionar</div>
          <div class="upload-hint">Formatos: JPG, PNG (m√°x. 5MB por imagen - m√°ximo 5 fotos)</div>
          <input type="file" name="fotografias" id="fileInput" multiple accept="image/*" style="display:none;">
        </div>
        <div class="image-preview-container" id="imagePreview"></div>
        <div id="fileCountIndicator" style="margin-top:10px; color:#6B7280; font-size:0.9rem;">
          <i class="fas fa-images"></i> Archivos seleccionados: <strong id="fileCount">0</strong>/5
        </div>
      </div>

      <!-- AN√ìNIMO -->
      <div class="info-box" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border:none;">
        <h5 style="color:white;"><i class="fas fa-user-secret"></i> Privacidad del Reporte</h5>
        <div class="form-check" style="margin:15px 0;">
          {{ form.anonimo }}
          <label class="form-check-label" for="id_anonimo" style="color:white;">
            <i class="fas fa-shield-alt"></i> Enviar este reporte de forma an√≥nima
          </label>
        </div>
        <p class="mb-0" style="font-size:0.9rem; opacity:0.95;">
          Si marcas esta opci√≥n, tu nombre, email y tel√©fono NO ser√°n almacenados ni mostrados p√∫blicamente.
        </p>
      </div>

      <!-- CONTACTO -->
      <div id="contactFields">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label"><i class="fas fa-user"></i> Tu Nombre <span class="required" id="nombreRequired">*</span></label>
            {{ form.nombre_reportante }}
            {% if form.nombre_reportante.errors %}<div class="text-danger"><i class="fas fa-exclamation-circle"></i> {{ form.nombre_reportante.errors }}</div>{% endif %}
          </div>
          <div class="form-group">
            <label class="form-label"><i class="fas fa-envelope"></i> Email de Contacto <span class="required" id="emailRequired">*</span></label>
            {{ form.email_reportante }}
            {% if form.email_reportante.errors %}<div class="text-danger"><i class="fas fa-exclamation-circle"></i> {{ form.email_reportante.errors }}</div>{% endif %}
          </div>
        </div>
        <div class="form-group">
          <label class="form-label"><i class="fas fa-phone"></i> Tel√©fono (Opcional)</label>
          {{ form.telefono_reportante }}
          {% if form.telefono_reportante.errors %}<div class="text-danger"><i class="fas fa-exclamation-circle"></i> {{ form.telefono_reportante.errors }}</div>{% endif %}
        </div>
      </div>
    </div>

    <!-- ACCIONES -->
    <div class="form-actions">
      <a href="{% url 'index' %}" class="btn btn-cancel">
        <i class="fas fa-times"></i> Cancelar
      </a>
      <button type="button" class="btn btn-prev" id="btnPrev" style="display:none;">
        <i class="fas fa-arrow-left"></i> Anterior
      </button>
      <button type="button" class="btn btn-next" id="btnNext">
        Continuar <i class="fas fa-arrow-right"></i>
      </button>
      <button type="submit" class="btn btn-submit" id="btnSubmit" style="display:none;">
        <i class="fas fa-paper-plane"></i> Enviar Reporte
      </button>
    </div>
  </form>
</div>

{% endblock %}

{% block extra_scripts %}
    <!-- Leaflet + SweetAlert -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- TU JS STATIC -->
    <script src="{% static 'js/nuevo_reporte.js' %}"></script>
<script>
/* ========================= MENSAJES DJANGO ========================= */
{% if messages %}
    {% for message in messages %}
    Swal.fire({
        icon: '{{ message.tags }}',
        title: '{{ message|escapejs }}',
        confirmButtonColor: '#8B5CF6'
    });
    {% endfor %}
{% endif %}

{% if form.errors %}
console.error('‚ùå ERRORES DEL FORMULARIO:');
{% for field, errors in form.errors.items %}
console.error('Campo {{ field }}:', '{{ errors|first|escapejs }}');
{% endfor %}
{% endif %}
</script>

{% endblock %}